window.CFGEO=function(window,document,$){"use strict";var l10n=window.cfgeo_l10,setTimeout=window.setTimeout,cfgeo={formfield:"",idNumber:!1,file_frames:{},repeatEls:'input:not([type="button"]),select,textarea,.cfgeo_media_status'};return cfgeo.metabox=function(){return cfgeo.$metabox?cfgeo.$metabox:(cfgeo.$metabox=$("table.cfgeo_metabox"),cfgeo.$metabox)},cfgeo.init=function(){var $metabox=cfgeo.metabox(),$repeatGroup=$metabox.find(".repeatable-group");l10n.new_admin_style&&$metabox.find(".cfgeo-spinner img").hide(),cfgeo.initPickers($metabox.find("input:text.cfgeo_timepicker"),$metabox.find("input:text.cfgeo_datepicker"),$metabox.find("input:text.cfgeo_colorpicker")),$("#ui-datepicker-div").wrap('<div class="cfgeo_element" />'),$('<p><span class="button cfgeo-multicheck-toggle">'+l10n.check_toggle+"</span></p>").insertBefore("ul.cfgeo_checkbox_list"),$metabox.on("change",".cfgeo_upload_file",function(){cfgeo.formfield=$(this).attr("id"),$("#"+cfgeo.formfield+"_id").val("")}).on("click",".cfgeo-multicheck-toggle",cfgeo.toggleCheckBoxes).on("click",".cfgeo_upload_button",cfgeo.handleMedia).on("click",".cfgeo_remove_file_button",cfgeo.handleRemoveMedia).on("click",".add-group-row",cfgeo.addGroupRow).on("click",".add-row-button",cfgeo.addAjaxRow).on("click",".remove-group-row",cfgeo.removeGroupRow).on("click",".remove-row-button",cfgeo.removeAjaxRow).on("keyup paste focusout",".cfgeo_oembed",cfgeo.maybeOembed).on("cfgeo_remove_row",".repeatable-group",cfgeo.resetTitlesAndIterator),$repeatGroup.length&&$repeatGroup.filter(".sortable").each(function(){$(this).find(".remove-group-row").before('<a class="shift-rows move-up alignleft" href="#">'+l10n.up_arrow+'</a> <a class="shift-rows move-down alignleft" href="#">'+l10n.down_arrow+"</a>")}).on("click",".shift-rows",cfgeo.shiftRows).on("cfgeo_add_row",cfgeo.emptyValue),setTimeout(cfgeo.resizeoEmbeds,500),$(window).on("resize",cfgeo.resizeoEmbeds)},cfgeo.resetTitlesAndIterator=function(){$(".repeatable-group").each(function(){var $table=$(this);$table.find(".repeatable-grouping").each(function(rowindex){var $row=$(this);$row.data("iterator",rowindex),$row.find(".cfgeo-group-title h4").text($table.find(".add-group-row").data("grouptitle").replace("{#}",rowindex+1))})})},cfgeo.toggleCheckBoxes=function(event){event.preventDefault();var $self=$(this),$multicheck=$self.parents("td").find("input[type=checkbox]");$self.data("checked")?($multicheck.prop("checked",!1),$self.data("checked",!1)):($multicheck.prop("checked",!0),$self.data("checked",!0))},cfgeo.handleMedia=function(event){if(wp){event.preventDefault();var $metabox=cfgeo.metabox(),$self=$(this);cfgeo.formfield=$self.prev("input").attr("id");var $formfield=$("#"+cfgeo.formfield),formName=$formfield.attr("name"),uploadStatus=!0,attachment=!0,isList=$self.hasClass("cfgeo_upload_list");if(cfgeo.formfield in cfgeo.file_frames)return void cfgeo.file_frames[cfgeo.formfield].open();cfgeo.file_frames[cfgeo.formfield]=wp.media.frames.file_frame=wp.media({title:$metabox.find("label[for="+cfgeo.formfield+"]").text(),button:{text:l10n.upload_file},multiple:isList?!0:!1});var handlers={list:function(selection){attachment=selection.toJSON(),$formfield.val(attachment.url),$("#"+cfgeo.formfield+"_id").val(attachment.id);var fileGroup=[];$(attachment).each(function(){uploadStatus=this.type&&"image"===this.type?'<li class="img_status"><img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'"><p><a href="#" class="cfgeo_remove_file_button" rel="'+cfgeo.formfield+"["+this.id+']">'+l10n.remove_image+'</a></p><input type="hidden" id="filelist-'+this.id+'" name="'+formName+"["+this.id+']" value="'+this.url+'"></li>':"<li>"+l10n.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+l10n.download+'</a> / <a href="#" class="cfgeo_remove_file_button" rel="'+cfgeo.formfield+"["+this.id+']">'+l10n.remove_file+'</a>)<input type="hidden" id="filelist-'+this.id+'" name="'+formName+"["+this.id+']" value="'+this.url+'"></li>',fileGroup.push(uploadStatus)}),$(fileGroup).each(function(){$formfield.siblings(".cfgeo_media_status").slideDown().append(this)})},single:function(selection){attachment=selection.first().toJSON(),$formfield.val(attachment.url),$("#"+cfgeo.formfield+"_id").val(attachment.id),uploadStatus=attachment.type&&"image"===attachment.type?'<div class="img_status"><img style="max-width: 350px; width: 100%; height: auto;" src="'+attachment.url+'" alt="'+attachment.filename+'" title="'+attachment.filename+'" /><p><a href="#" class="cfgeo_remove_file_button" rel="'+cfgeo.formfield+'">'+l10n.remove_image+"</a></p></div>":l10n.file+" <strong>"+attachment.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+attachment.url+'" target="_blank" rel="external">'+l10n.download+'</a> / <a href="#" class="cfgeo_remove_file_button" rel="'+cfgeo.formfield+'">'+l10n.remove_file+"</a>)",$formfield.siblings(".cfgeo_media_status").slideDown().html(uploadStatus)}};cfgeo.file_frames[cfgeo.formfield].on("select",function(){var selection=cfgeo.file_frames[cfgeo.formfield].state().get("selection"),type=isList?"list":"single";handlers[type](selection)}),cfgeo.file_frames[cfgeo.formfield].open()}},cfgeo.handleRemoveMedia=function(event){event.preventDefault();var $self=$(this);if($self.is(".attach_list .cfgeo_remove_file_button"))return $self.parents("li").remove(),!1;cfgeo.formfield=$self.attr("rel");var $container=$self.parents(".img_status");return cfgeo.metabox().find("input#"+cfgeo.formfield).val(""),cfgeo.metabox().find("input#"+cfgeo.formfield+"_id").val(""),$container.length?$container.html(""):$self.parents(".cfgeo_media_status").html(""),!1},$.fn.replaceText=function(b,a,c){return this.each(function(){var g,e,f=this.firstChild,d=[];if(f)do 3===f.nodeType&&(g=f.nodeValue,e=g.replace(b,a),e!==g&&(!c&&/</.test(e)?($(f).before(e),d.push(f)):f.nodeValue=e));while(f=f.nextSibling);d.length&&$(d).remove()})},$.fn.cleanRow=function(prevNum,group){var $self=$(this),$inputs=$self.find('input:not([type="button"]), select, textarea, label');return group&&$self.find(".cfgeo-repeat-table .repeat-row:not(:first-child)").remove(),cfgeo.$focus=!1,cfgeo.neweditor_id=[],$inputs.filter(":checked").removeAttr("checked"),$inputs.filter(":selected").removeAttr("selected"),$self.find(".cfgeo-group-title")&&$self.find(".cfgeo-group-title h4").text($self.data("title").replace("{#}",cfgeo.idNumber+1)),$inputs.each(function(){var newID,oldID,$newInput=$(this),isEditor=$newInput.hasClass("wp-editor-area"),oldFor=$newInput.attr("for"),attrs={};if(oldFor)attrs={"for":oldFor.replace("_"+prevNum,"_"+cfgeo.idNumber)};else{var oldName=$newInput.attr("name"),newName=oldName?oldName.replace("["+prevNum+"]","["+cfgeo.idNumber+"]"):"";oldID=$newInput.attr("id"),newID=oldID?oldID.replace("_"+prevNum,"_"+cfgeo.idNumber):"",attrs={id:newID,name:newName,"data-iterator":cfgeo.idNumber}}if($newInput.removeClass("hasDatepicker").attr(attrs).val(""),isEditor){newID=newID?oldID.replace("zx"+prevNum,"zx"+cfgeo.idNumber):"",$newInput.html("");var $wysiwyg=$newInput.parents(".cfgeo-type-wysiwyg");$wysiwyg.find(".mce-tinymce:not(:first-child)").remove();var html=$wysiwyg.html().replace(new RegExp(oldID,"g"),newID);$wysiwyg.html(html),cfgeo.neweditor_id.push({id:newID,old:oldID})}cfgeo.$focus=cfgeo.$focus?cfgeo.$focus:$newInput}),this},$.fn.newRowHousekeeping=function(){var $row=$(this),$colorPicker=$row.find(".wp-picker-container"),$list=$row.find(".cfgeo_media_status");return $colorPicker.length&&$colorPicker.each(function(){var $td=$(this).parent();$td.html($td.find("input:text.cfgeo_colorpicker").attr("style",""))}),$list.length&&$list.empty(),this},cfgeo.afterRowInsert=function($row){cfgeo.$focus&&cfgeo.$focus.focus();var _prop;if(cfgeo.neweditor_id.length){var i;for(i=cfgeo.neweditor_id.length-1;i>=0;i--){var id=cfgeo.neweditor_id[i].id,old=cfgeo.neweditor_id[i].old;if("undefined"==typeof tinyMCEPreInit.mceInit[id]){var newSettings=jQuery.extend({},tinyMCEPreInit.mceInit[old]);for(_prop in newSettings)"string"==typeof newSettings[_prop]&&(newSettings[_prop]=newSettings[_prop].replace(new RegExp(old,"g"),id));tinyMCEPreInit.mceInit[id]=newSettings}if("undefined"==typeof tinyMCEPreInit.qtInit[id]){var newQTS=jQuery.extend({},tinyMCEPreInit.qtInit[old]);for(_prop in newQTS)"string"==typeof newQTS[_prop]&&(newQTS[_prop]=newQTS[_prop].replace(new RegExp(old,"g"),id));tinyMCEPreInit.qtInit[id]=newQTS}tinyMCE.init({id:tinyMCEPreInit.mceInit[id]})}}cfgeo.initPickers($row.find("input:text.cfgeo_timepicker"),$row.find("input:text.cfgeo_datepicker"),$row.find("input:text.cfgeo_colorpicker"))},cfgeo.updateNameAttr=function(){var $this=$(this),name=$this.attr("name");if("undefined"==typeof name)return!1;var prevNum=parseInt($this.parents(".repeatable-grouping").data("iterator")),newNum=prevNum-1,$newName=name.replace("["+prevNum+"]","["+newNum+"]");$this.attr("name",$newName)},cfgeo.emptyValue=function(event,row){$('input:not([type="button"]), textarea',row).val("")},cfgeo.addGroupRow=function(event){event.preventDefault();var $self=$(this),$table=$("#"+$self.data("selector")),$oldRow=$table.find(".repeatable-grouping").last(),prevNum=parseInt($oldRow.data("iterator"));cfgeo.idNumber=prevNum+1;var $row=$oldRow.clone();$row.data("title",$self.data("grouptitle")).newRowHousekeeping().cleanRow(prevNum,!0);var $newRow=$('<tr class="repeatable-grouping" data-iterator="'+cfgeo.idNumber+'">'+$row.html()+"</tr>");$oldRow.after($newRow),cfgeo.afterRowInsert($newRow),$table.find(".repeatable-grouping").length<=1?$table.find(".remove-group-row").prop("disabled",!0):$table.find(".remove-group-row").removeAttr("disabled"),$table.trigger("cfgeo_add_row",$newRow)},cfgeo.addAjaxRow=function(event){event.preventDefault();var $self=$(this),tableselector="#"+$self.data("selector"),$table=$(tableselector),$emptyrow=$table.find(".empty-row"),prevNum=parseInt($emptyrow.find("[data-iterator]").data("iterator"));cfgeo.idNumber=prevNum+1;var $row=$emptyrow.clone();$row.newRowHousekeeping().cleanRow(prevNum),$emptyrow.removeClass("empty-row").addClass("repeat-row"),$emptyrow.after($row),cfgeo.afterRowInsert($row),$table.trigger("cfgeo_add_row",$row)},cfgeo.removeGroupRow=function(event){event.preventDefault();var $self=$(this),$table=$("#"+$self.data("selector")),$parent=$self.parents(".repeatable-grouping"),noRows=$table.find(".repeatable-grouping").length;$parent.nextAll(".repeatable-grouping").find(cfgeo.repeatEls).each(cfgeo.updateNameAttr),noRows>1&&($parent.remove(),3>noRows?$table.find(".remove-group-row").prop("disabled",!0):$table.find(".remove-group-row").prop("disabled",!1),$table.trigger("cfgeo_remove_row"))},cfgeo.removeAjaxRow=function(event){event.preventDefault();var $self=$(this),$parent=$self.parents("tr"),$table=$self.parents(".cfgeo-repeat-table");$table.find("tr").length>1&&($parent.hasClass("empty-row")&&$parent.prev().addClass("empty-row").removeClass("repeat-row"),$self.parents(".cfgeo-repeat-table tr").remove(),$table.trigger("cfgeo_remove_row"))},cfgeo.shiftRows=function(event){event.preventDefault();var $self=$(this),$parent=$self.parents(".repeatable-grouping"),$goto=$self.hasClass("move-up")?$parent.prev(".repeatable-grouping"):$parent.next(".repeatable-grouping");if($goto.length){var inputVals=[];$parent.find(cfgeo.repeatEls).each(function(){var val,$element=$(this);$element.hasClass("cfgeo_media_status")?val=$element.html():"checkbox"===$element.attr("type")?(val=$element.is(":checked"),cfgeo.log("checked",val)):"select"===$element.prop("tagName")?(val=$element.is(":selected"),cfgeo.log("checked",val)):val=$element.val(),inputVals.push({val:val,$:$element})}),$goto.find(cfgeo.repeatEls).each(function(index){var val,$element=$(this);$element.hasClass("cfgeo_media_status")?(val=$element.html(),$element.html(inputVals[index].val),inputVals[index].$.html(val)):"checkbox"===$element.attr("type")?(inputVals[index].$.prop("checked",$element.is(":checked")),$element.prop("checked",inputVals[index].val)):"select"===$element.prop("tagName")?(inputVals[index].$.prop("selected",$element.is(":selected")),$element.prop("selected",inputVals[index].val)):(inputVals[index].$.val($element.val()),$element.val(inputVals[index].val))})}},cfgeo.initPickers=function($timePickers,$datePickers,$colorPickers){cfgeo.initTimePickers($timePickers),cfgeo.initDatePickers($datePickers),cfgeo.initColorPickers($colorPickers)},cfgeo.initTimePickers=function($selector){$selector.length&&$selector.timePicker({startTime:"00:00",endTime:"23:59",show24Hours:!1,separator:":",step:30})},cfgeo.initDatePickers=function($selector){$selector.length&&($selector.datepicker("destroy"),$selector.datepicker())},cfgeo.initColorPickers=function($selector){$selector.length&&("object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?$selector.wpColorPicker():$selector.each(function(i){$(this).after('<div id="picker-'+i+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),$("#picker-"+i).hide().farbtastic($(this))}).focus(function(){$(this).next().show()}).blur(function(){$(this).next().hide()}))},cfgeo.maybeOembed=function(evt){var $self=$(this),type=evt.type,m={focusout:function(){setTimeout(function(){cfgeo.spinner(".postbox table.cfgeo_metabox",!0)},2e3)},keyup:function(){var betw=function(min,max){return evt.which<=max&&evt.which>=min};(betw(48,90)||betw(96,111)||betw(8,9)||187===evt.which||190===evt.which)&&cfgeo.doAjax($self,evt)},paste:function(){setTimeout(function(){cfgeo.doAjax($self)},100)}};m[type]()},cfgeo.resizeoEmbeds=function(){cfgeo.metabox().each(function(){var $self=$(this),$tableWrap=$self.parents(".inside");if(!$tableWrap.length)return!0;var newWidth=Math.round(.82*$tableWrap.width()*.97)-30;if(newWidth>639)return!0;var $embeds=$self.find(".cfgeo-type-oembed .embed_status"),$children=$embeds.children().not(".cfgeo_remove_wrapper");return $children.length?void $children.each(function(){var $self=$(this),iwidth=$self.width(),iheight=$self.height(),_newWidth=newWidth;$self.parents(".repeat-row").length&&(_newWidth=newWidth-91);var newHeight=Math.round(_newWidth*iheight/iwidth);$self.width(_newWidth).height(newHeight)}):!0})},cfgeo.log=function(){l10n.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},cfgeo.spinner=function($context,hide){hide?$(".cfgeo-spinner",$context).hide():$(".cfgeo-spinner",$context).show()},cfgeo.doAjax=function($obj){var oembed_url=$obj.val();if(!(oembed_url.length<6)){var field_id=$obj.attr("id"),$context=$obj.parents(".cfgeo-repeat-table  tr td");$context=$context.length?$context:$obj.parents(".cfgeo_metabox tr td");var embed_container=$(".embed_status",$context),oembed_width=$obj.width(),child_el=$(":first-child",embed_container);cfgeo.log("oembed_url",oembed_url,field_id),oembed_width=embed_container.length&&child_el.length?child_el.width():$obj.width(),cfgeo.spinner($context),$(".embed_wrap",$context).html(""),setTimeout(function(){$(".cfgeo_oembed:focus").val()===oembed_url&&$.ajax({type:"post",dataType:"json",url:l10n.ajaxurl,data:{action:"cfgeo_oembed_handler",oembed_url:oembed_url,oembed_width:oembed_width>300?oembed_width:300,field_id:field_id,object_id:$obj.data("objectid"),object_type:$obj.data("objecttype"),cfgeo_ajax_nonce:l10n.ajax_nonce},success:function(response){cfgeo.log(response),"undefined"!=typeof response.id&&(cfgeo.spinner($context,!0),$(".embed_wrap",$context).html(response.result))}})},500)}},$(document).ready(cfgeo.init),cfgeo}(window,document,jQuery);